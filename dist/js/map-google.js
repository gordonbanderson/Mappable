function MarkerClusterer(t,e,r){this.extend(MarkerClusterer,google.maps.OverlayView),this.map_=t,this.markers_=[],this.clusters_=[],this.sizes=[53,56,66,78,90],this.styles_=[],this.ready_=!1;var o=r||{};this.gridSize_=o.gridSize||60,this.minClusterSize_=o.minimumClusterSize||2,this.maxZoom_=o.maxZoom||null,this.styles_=o.styles||[],this.imagePath_=o.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_,this.imageExtension_=o.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_,this.zoomOnClick_=!0,void 0!=o.zoomOnClick&&(this.zoomOnClick_=o.zoomOnClick),this.averageCenter_=!1,void 0!=o.averageCenter&&(this.averageCenter_=o.averageCenter),this.setupStyles_(),this.setMap(t),this.prevZoom_=this.map_.getZoom();var s=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){var t=s.map_.getZoom(),e=s.map_.minZoom||0,r=Math.min(s.map_.maxZoom||100,s.map_.mapTypes[s.map_.getMapTypeId()].maxZoom);t=Math.min(Math.max(t,e),r),s.prevZoom_!=t&&(s.prevZoom_=t,s.resetViewport())}),google.maps.event.addListener(this.map_,"idle",function(){s.redraw()}),e&&(e.length||Object.keys(e).length)&&this.addMarkers(e,!1)}function Cluster(t){this.markerClusterer_=t,this.map_=t.getMap(),this.gridSize_=t.getGridSize(),this.minClusterSize_=t.getMinClusterSize(),this.averageCenter_=t.isAverageCenter(),this.center_=null,this.markers_=[],this.bounds_=null,this.clusterIcon_=new ClusterIcon(this,t.getStyles(),t.getGridSize())}function ClusterIcon(t,e,r){t.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView),this.styles_=e,this.padding_=r||0,this.cluster_=t,this.center_=null,this.map_=t.getMap(),this.div_=null,this.sums_=null,this.visible_=!1,this.setMap(this.map_)}MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_PATH_="../resources/mappable/client/dist/images/m",MarkerClusterer.prototype.MARKER_CLUSTER_IMAGE_EXTENSION_="png",MarkerClusterer.prototype.extend=function(t,e){return function(t){for(var e in t.prototype)this.prototype[e]=t.prototype[e];return this}.apply(t,[e])},MarkerClusterer.prototype.onAdd=function(){this.setReady_(!0)},MarkerClusterer.prototype.draw=function(){},MarkerClusterer.prototype.setupStyles_=function(){if(!this.styles_.length)for(var t,e=0;t=this.sizes[e];e++)this.styles_.push({url:this.imagePath_+(e+1)+"."+this.imageExtension_,height:t,width:t})},MarkerClusterer.prototype.fitMapToMarkers=function(){for(var t,e=this.getMarkers(),r=new google.maps.LatLngBounds,o=0;t=e[o];o++)r.extend(t.getPosition());this.map_.fitBounds(r)},MarkerClusterer.prototype.setStyles=function(t){this.styles_=t},MarkerClusterer.prototype.getStyles=function(){return this.styles_},MarkerClusterer.prototype.isZoomOnClick=function(){return this.zoomOnClick_},MarkerClusterer.prototype.isAverageCenter=function(){return this.averageCenter_},MarkerClusterer.prototype.getMarkers=function(){return this.markers_},MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_.length},MarkerClusterer.prototype.setMaxZoom=function(t){this.maxZoom_=t},MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_},MarkerClusterer.prototype.calculator_=function(t,e){for(var r=0,o=t.length,s=o;0!==s;)s=parseInt(s/10,10),r++;return{text:o,index:r=Math.min(r,e)}},MarkerClusterer.prototype.setCalculator=function(t){this.calculator_=t},MarkerClusterer.prototype.getCalculator=function(){return this.calculator_},MarkerClusterer.prototype.addMarkers=function(t,e){if(t.length)for(var r=0;o=t[r];r++)this.pushMarkerTo_(o);else if(Object.keys(t).length)for(var o in t)this.pushMarkerTo_(t[o]);e||this.redraw()},MarkerClusterer.prototype.pushMarkerTo_=function(t){if(t.isAdded=!1,t.draggable){var e=this;google.maps.event.addListener(t,"dragend",function(){t.isAdded=!1,e.repaint()})}this.markers_.push(t)},MarkerClusterer.prototype.addMarker=function(t,e){this.pushMarkerTo_(t),e||this.redraw()},MarkerClusterer.prototype.removeMarker_=function(t){var e=-1;if(this.markers_.indexOf)e=this.markers_.indexOf(t);else for(var r,o=0;r=this.markers_[o];o++)if(r==t){e=o;break}return-1!=e&&(t.setMap(null),this.markers_.splice(e,1),!0)},MarkerClusterer.prototype.removeMarker=function(t,e){var r=this.removeMarker_(t);return!(e||!r)&&(this.resetViewport(),this.redraw(),!0)},MarkerClusterer.prototype.removeMarkers=function(t,e){for(var r,o=t===this.getMarkers()?t.slice():t,s=!1,a=0;r=o[a];a++){var i=this.removeMarker_(r);s=s||i}if(!e&&s)return this.resetViewport(),this.redraw(),!0},MarkerClusterer.prototype.setReady_=function(t){this.ready_||(this.ready_=t,this.createClusters_())},MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length},MarkerClusterer.prototype.getMap=function(){return this.map_},MarkerClusterer.prototype.setMap=function(t){this.map_=t},MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_},MarkerClusterer.prototype.setGridSize=function(t){this.gridSize_=t},MarkerClusterer.prototype.getMinClusterSize=function(){return this.minClusterSize_},MarkerClusterer.prototype.setMinClusterSize=function(t){this.minClusterSize_=t},MarkerClusterer.prototype.getExtendedBounds=function(t){var e=this.getProjection(),r=new google.maps.LatLng(t.getNorthEast().lat(),t.getNorthEast().lng()),o=new google.maps.LatLng(t.getSouthWest().lat(),t.getSouthWest().lng()),s=e.fromLatLngToDivPixel(r);s.x+=this.gridSize_,s.y-=this.gridSize_;var a=e.fromLatLngToDivPixel(o);a.x-=this.gridSize_,a.y+=this.gridSize_;var i=e.fromDivPixelToLatLng(s),n=e.fromDivPixelToLatLng(a);return t.extend(i),t.extend(n),t},MarkerClusterer.prototype.isMarkerInBounds_=function(t,e){return e.contains(t.getPosition())},MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport(!0),this.markers_=[]},MarkerClusterer.prototype.resetViewport=function(t){for(var e,r=0;e=this.clusters_[r];r++)e.remove();var o;for(r=0;o=this.markers_[r];r++)o.isAdded=!1,t&&o.setMap(null);this.clusters_=[]},MarkerClusterer.prototype.repaint=function(){var t=this.clusters_.slice();this.clusters_.length=0,this.resetViewport(),this.redraw(),window.setTimeout(function(){for(var e,r=0;e=t[r];r++)e.remove()},0)},MarkerClusterer.prototype.redraw=function(){this.createClusters_()},MarkerClusterer.prototype.distanceBetweenPoints_=function(t,e){if(!t||!e)return 0;var r=(e.lat()-t.lat())*Math.PI/180,o=(e.lng()-t.lng())*Math.PI/180,s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(t.lat()*Math.PI/180)*Math.cos(e.lat()*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))},MarkerClusterer.prototype.addToClosestCluster_=function(t){for(var e,r=4e4,o=null,s=(t.getPosition(),0);e=this.clusters_[s];s++){var a=e.getCenter();if(a){var i=this.distanceBetweenPoints_(a,t.getPosition());i<r&&(r=i,o=e)}}o&&o.isMarkerInClusterBounds(t)?o.addMarker(t):((e=new Cluster(this)).addMarker(t),this.clusters_.push(e))},MarkerClusterer.prototype.createClusters_=function(){if(this.ready_)for(var t,e=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast()),r=this.getExtendedBounds(e),o=0;t=this.markers_[o];o++)!t.isAdded&&this.isMarkerInBounds_(t,r)&&this.addToClosestCluster_(t)},Cluster.prototype.isMarkerAlreadyAdded=function(t){if(this.markers_.indexOf)return-1!=this.markers_.indexOf(t);for(var e,r=0;e=this.markers_[r];r++)if(e==t)return!0;return!1},Cluster.prototype.addMarker=function(t){if(this.isMarkerAlreadyAdded(t))return!1;if(this.center_){if(this.averageCenter_){var e=this.markers_.length+1,r=(this.center_.lat()*(e-1)+t.getPosition().lat())/e,o=(this.center_.lng()*(e-1)+t.getPosition().lng())/e;this.center_=new google.maps.LatLng(r,o),this.calculateBounds_()}}else this.center_=t.getPosition(),this.calculateBounds_();t.isAdded=!0,this.markers_.push(t);var s=this.markers_.length;if(s<this.minClusterSize_&&t.getMap()!=this.map_&&t.setMap(this.map_),s==this.minClusterSize_)for(var a=0;a<s;a++)this.markers_[a].setMap(null);return s>=this.minClusterSize_&&t.setMap(null),this.updateIcon(),!0},Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_},Cluster.prototype.getBounds=function(){for(var t,e=new google.maps.LatLngBounds(this.center_,this.center_),r=this.getMarkers(),o=0;t=r[o];o++)e.extend(t.getPosition());return e},Cluster.prototype.remove=function(){this.clusterIcon_.remove(),this.markers_.length=0,delete this.markers_},Cluster.prototype.getSize=function(){return this.markers_.length},Cluster.prototype.getMarkers=function(){return this.markers_},Cluster.prototype.getCenter=function(){return this.center_},Cluster.prototype.calculateBounds_=function(){var t=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(t)},Cluster.prototype.isMarkerInClusterBounds=function(t){return this.bounds_.contains(t.getPosition())},Cluster.prototype.getMap=function(){return this.map_},Cluster.prototype.updateIcon=function(){var t=this.map_.getZoom(),e=this.markerClusterer_.getMaxZoom();if(e&&t>e)for(var r,o=0;r=this.markers_[o];o++)r.setMap(this.map_);else if(this.markers_.length<this.minClusterSize_)this.clusterIcon_.hide();else{var s=this.markerClusterer_.getStyles().length,a=this.markerClusterer_.getCalculator()(this.markers_,s);this.clusterIcon_.setCenter(this.center_),this.clusterIcon_.setSums(a),this.clusterIcon_.show()}},ClusterIcon.prototype.triggerClusterClick=function(){var t=this.cluster_.getMarkerClusterer();google.maps.event.trigger(t.map_,"clusterclick",this.cluster_),t.isZoomOnClick()&&this.map_.fitBounds(this.cluster_.getBounds())},ClusterIcon.prototype.onAdd=function(){if(this.div_=document.createElement("DIV"),this.visible_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(t),this.div_.innerHTML=this.sums_.text}this.getPanes().overlayMouseTarget.appendChild(this.div_);var e=this;google.maps.event.addDomListener(this.div_,"click",function(){e.triggerClusterClick()})},ClusterIcon.prototype.getPosFromLatLng_=function(t){var e=this.getProjection().fromLatLngToDivPixel(t);return e.x-=parseInt(this.width_/2,10),e.y-=parseInt(this.height_/2,10),e},ClusterIcon.prototype.draw=function(){if(this.visible_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.top=t.y+"px",this.div_.style.left=t.x+"px",this.div_.style.zIndex=google.maps.Marker.MAX_ZINDEX+1}},ClusterIcon.prototype.hide=function(){this.div_&&(this.div_.style.display="none"),this.visible_=!1},ClusterIcon.prototype.show=function(){if(this.div_){var t=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(t),this.div_.style.display=""}this.visible_=!0},ClusterIcon.prototype.remove=function(){this.setMap(null)},ClusterIcon.prototype.onRemove=function(){this.div_&&this.div_.parentNode&&(this.hide(),this.div_.parentNode.removeChild(this.div_),this.div_=null)},ClusterIcon.prototype.setSums=function(t){this.sums_=t,this.text_=t.text,this.index_=t.index,this.div_&&(this.div_.innerHTML=t.text),this.useStyle()},ClusterIcon.prototype.useStyle=function(){var t=Math.max(0,this.sums_.index-1);t=Math.min(this.styles_.length-1,t);var e=this.styles_[t];this.url_=e.url,this.height_=e.height,this.width_=e.width,this.textColor_=e.textColor,this.anchor_=e.anchor,this.textSize_=e.textSize,this.backgroundPosition_=e.backgroundPosition},ClusterIcon.prototype.setCenter=function(t){this.center_=t},ClusterIcon.prototype.createCss=function(t){var e=[];e.push("background-image:url("+this.url_+");");var r=this.backgroundPosition_?this.backgroundPosition_:"0 0";e.push("background-position:"+r+";"),"object"==typeof this.anchor_?("number"==typeof this.anchor_[0]&&this.anchor_[0]>0&&this.anchor_[0]<this.height_?e.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;"):e.push("height:"+this.height_+"px; line-height:"+this.height_+"px;"),"number"==typeof this.anchor_[1]&&this.anchor_[1]>0&&this.anchor_[1]<this.width_?e.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;"):e.push("width:"+this.width_+"px; text-align:center;")):e.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");var o=this.textColor_?this.textColor_:"black",s=this.textSize_?this.textSize_:11;return e.push("cursor:pointer; top:"+t.y+"px; left:"+t.x+"px; color:"+o+"; position:absolute; font-size:"+s+"px; font-family:Arial,sans-serif; font-weight:bold"),e.join("")};var primeMap,window=window||{};function loadedGoogleMapsAPI(){console.log("About to call prime map"),primeMap()}function getGoogleMapsKey(){return $(".mappable-map").first().attr("data-google-map-key")}function getGoogleMapsLanguage(){return $(".mappable-map").first().attr("data-google-map-lang")}window.MarkerClusterer=MarkerClusterer,MarkerClusterer.prototype.addMarker=MarkerClusterer.prototype.addMarker,MarkerClusterer.prototype.addMarkers=MarkerClusterer.prototype.addMarkers,MarkerClusterer.prototype.clearMarkers=MarkerClusterer.prototype.clearMarkers,MarkerClusterer.prototype.fitMapToMarkers=MarkerClusterer.prototype.fitMapToMarkers,MarkerClusterer.prototype.getCalculator=MarkerClusterer.prototype.getCalculator,MarkerClusterer.prototype.getGridSize=MarkerClusterer.prototype.getGridSize,MarkerClusterer.prototype.getExtendedBounds=MarkerClusterer.prototype.getExtendedBounds,MarkerClusterer.prototype.getMap=MarkerClusterer.prototype.getMap,MarkerClusterer.prototype.getMarkers=MarkerClusterer.prototype.getMarkers,MarkerClusterer.prototype.getMaxZoom=MarkerClusterer.prototype.getMaxZoom,MarkerClusterer.prototype.getStyles=MarkerClusterer.prototype.getStyles,MarkerClusterer.prototype.getTotalClusters=MarkerClusterer.prototype.getTotalClusters,MarkerClusterer.prototype.getTotalMarkers=MarkerClusterer.prototype.getTotalMarkers,MarkerClusterer.prototype.redraw=MarkerClusterer.prototype.redraw,MarkerClusterer.prototype.removeMarker=MarkerClusterer.prototype.removeMarker,MarkerClusterer.prototype.removeMarkers=MarkerClusterer.prototype.removeMarkers,MarkerClusterer.prototype.resetViewport=MarkerClusterer.prototype.resetViewport,MarkerClusterer.prototype.repaint=MarkerClusterer.prototype.repaint,MarkerClusterer.prototype.setCalculator=MarkerClusterer.prototype.setCalculator,MarkerClusterer.prototype.setGridSize=MarkerClusterer.prototype.setGridSize,MarkerClusterer.prototype.setMaxZoom=MarkerClusterer.prototype.setMaxZoom,MarkerClusterer.prototype.onAdd=MarkerClusterer.prototype.onAdd,MarkerClusterer.prototype.draw=MarkerClusterer.prototype.draw,Cluster.prototype.getCenter=Cluster.prototype.getCenter,Cluster.prototype.getSize=Cluster.prototype.getSize,Cluster.prototype.getMarkers=Cluster.prototype.getMarkers,ClusterIcon.prototype.onAdd=ClusterIcon.prototype.onAdd,ClusterIcon.prototype.draw=ClusterIcon.prototype.draw,ClusterIcon.prototype.onRemove=ClusterIcon.prototype.onRemove,Object.keys=Object.keys||function(t){var e=[];for(var r in t)t.hasOwnProperty(r)&&e.push(r);return e},"object"==typeof module&&(module.exports=MarkerClusterer),function(t){var e=[];function r(t,r,o,s,a,i,n,l,p,u){mapId=t.getDiv().getAttribute("id");var h=new google.maps.Marker;if(h.setPosition(new google.maps.LatLng(r,o)),h.mycategory=a,i&&""!==i){var g=new google.maps.MarkerImage(i);h.setIcon(g)}return"1"!=n&&h.setMap(t),google.maps.event.addListener(h,"click",function(){l&&t.setCenter(new google.maps.LatLng(r,o),p);var a=e[mapId];a.setContent(s),a.open(t,this)}),console.log(!1===u),"1"==u?h.setVisible(!1):h.setVisible(!0),h}function o(t){var e=google.maps.MapTypeId.ROADMAP;switch(t){case"aerial":e=google.maps.MapTypeId.SATELLITE;break;case"hybrid":e=google.maps.MapTypeId.HYBRID;break;case"terrain":e=google.maps.MapTypeId.TERRAIN}return e}primeMap=function(){console.log("In loadShortCodeMaps"),t("div[data-shortcode-map]").each(function(e){var r=t(this),s=r.attr("id"),a=o(r.attr("data-maptype")),i=parseFloat(r.attr("data-latitude")),n=parseFloat(r.attr("data-longitude")),l=parseInt(r.attr("data-zoom")),p=parseInt(r.attr("data-allowfullscreen")),u={center:{lat:i,lng:n},zoom:l,mapTypeId:a},h=new google.maps.Map(document.getElementById(s),u);1==p&&h.controls[google.maps.ControlPosition.TOP_RIGHT].push(FullScreenControl(h,"Full Screen","Original Size"))}),t("div[data-streetview]").each(function(e){var r=t(this),o=r.attr("id"),s=parseFloat(r.attr("data-latitude")),a=parseFloat(r.attr("data-longitude")),i=parseInt(r.attr("data-zoom")),n=parseFloat(r.attr("data-heading")),l=parseFloat(r.attr("data-pitch")),p={position:new google.maps.LatLng(s,a),pov:{heading:n,pitch:l},zoom:i},u=document.getElementById(o);new google.maps.StreetViewPanorama(u,p).setVisible(!0)}),t("div[data-map]").each(function(s){var a=t(this);mapdomid=a.attr("id");var n=new google.maps.Map(document.getElementById(mapdomid));geocoder=new google.maps.Geocoder;var l=parseInt(a.attr("data-allowfullscreen"));if(a.attr("data-mapstyles")){var p=t.parseJSON(a.attr("data-mapstyles"));n.setOptions({styles:p,fullscreenControl:l,zoomControl:!0,mapTypeControl:!0,scaleControl:!0,streetViewControl:!0,rotateControl:!0})}a.data["data-allowfullscreen"];var u=t.parseJSON(a.attr("data-mapmarkers")),h=a.attr("data-useclusterer"),g=a.attr("data-enableautocentrezoom"),d=function(t,e,o,s,a,i){t.minLat=1e6,t.minLng=1e6,t.maxLat=-1e6,t.maxLng=-1e6;for(var n=[],l=0;l<e.length;l++){var p=e[l],u=r(t,p.latitude,p.longitude,p.html,p.category,p.icon,o,s,a,i),h=parseFloat(p.latitude),g=parseFloat(p.longitude);h<t.minLat&&(t.minLat=h),h>t.maxLat&&(t.maxLat=h),g>t.maxLng&&(t.maxLng=g),g<t.minLng&&(t.minLng=g),n.push(u)}var d=[];return d.lat=(parseFloat(t.minLat)+parseFloat(t.maxLat))/2,d.lng=(parseFloat(t.minLng)+parseFloat(t.maxLng))/2,t.centreCoordinates=d,n}(n,u,h,g,a.attr("data-infowindowzoom"),a.attr("data-defaulthidemarker"));if(1==g){centre=t.parseJSON(a.attr("data-centre")),n.setCenter(new google.maps.LatLng(centre.lat,centre.lng));var c=new google.maps.LatLngBounds(new google.maps.LatLng(n.minLat,n.minLng),new google.maps.LatLng(n.maxLat,n.maxLng));n.fitBounds(c)}else{centre=t.parseJSON(a.attr("data-centre")),n.setCenter(new google.maps.LatLng(centre.lat,centre.lng));var m=parseInt(a.attr("data-zoom"));n.setZoom(m)}var _=o(a.attr("data-maptype"));if(n.setMapTypeId(_),console.log("Map type: "+_),1==h)new MarkerClusterer(n,d,{gridSize:parseInt(a.attr("data-clusterergridsize")),maxZoom:parseInt(a.attr("data-clusterermaxzoom"))});!function(t,e){for(i=0;i<e.length;i++){var r=e[i],o=[new google.maps.LatLng(r.lat1,r.lon1),new google.maps.LatLng(r.lat2,r.lon2)];new google.maps.Polyline({path:o,strokeColor:r.color,strokeWeight:4,strokeOpacity:.8}).setMap(t)}}(n,t.parseJSON(a.attr("data-lines"))),function(t,e){for(var r=0;r<e.length;r++){var o=e[r];new google.maps.KmlLayer(o,{suppressInfoWindows:!0,map:t})}}(n,t.parseJSON(a.attr("data-kmlfiles")));var M=new google.maps.InfoWindow({content:""});e[mapdomid]=M,a.trigger("mapInitialised",[n])})},window.loadGoogleMapsScript=function(){var t=getGoogleMapsKey(),e=getGoogleMapsLanguage();console.log("KEY: "+t,e);var r=document.createElement("script");r.type="text/javascript",r.src="https://maps.googleapis.com/maps/api/js?&callback=loadedGoogleMapsAPI&hl="+e+"&key="+t,document.body.appendChild(r)},window.addEventListener?window.addEventListener("load",loadGoogleMapsScript,!1):window.attachEvent&&window.attachEvent("onload",loadGoogleMapsScript)}(jQuery);